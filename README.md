# 家族スケジュールLINEボット＋LIFF

家族3人の週次スケジュール管理を、LINEボット＋LIFF画面で実現するシステムです。

## 📋 目次

- [システム概要](#システム概要)
- [タイミングシステム](#タイミングシステム)
- [アーキテクチャ](#アーキテクチャ)
- [主な機能](#主な機能)
- [セットアップ手順](#セットアップ手順)
- [コスト最適化](#コスト最適化)

## システム概要

### 主な特徴

- **週次スケジュール管理**: 月曜～日曜の1週間単位で管理
- **LINE連携**: LINEボットとLIFF画面で簡単入力
- **自動ポイント集計**: 平日・土日加算を自動計算
- **確定表の自動投稿**: 毎週日曜9:00に自動確定
- **2週間並行運用**: 確定週と入力週を同時管理

### ポイント計算ルール

- **終日**: 4P（土日は6P）
- **時間枠**（9/17/21/24時）: 各1P（土日は1.5P）
- **表示形式**: 「合計P（平日P + 土日加算P）」

## タイミングシステム

### 📅 週次スケジュール

```
┌─────────────────────────────────────────────────────┐
│          毎週の流れ（例：1/6～1/12 の週）            │
└─────────────────────────────────────────────────────┘

前週金曜 1/3（金）10:00
├─ 📨 翌週の予定入力リマインド送信
└─ 「来週の予定入力をお忘れなく！」

当週日曜 1/12（日）9:00
├─ ✅ 前週（1/6～1/12）の確定処理
├─ 📊 ポイント集計
├─ ⚠️ 担当者不在の日があれば警告
├─ 📨 確定メッセージ送信
└─ 💾 データベースに保存

翌週月曜 1/13（月）7:00
├─ 📨 PRIMARY 次週（1/13～1/19）の入力依頼送信
└─ LIFFリンクで入力を促進
```

### 🔄 2週間並行運用

システムは常に2つの週を同時に管理：

```
┌──────────────┐  ┌──────────────┐
│  確定済み週  │  │   入力週     │
│  (表示用)    │  │  (集計中)    │
└──────────────┘  └──────────────┘
    ↓ 閲覧          ↓ 編集可能
┌──────────────┐  ┌──────────────┐
│ ダッシュボード│  │  LIFF画面    │
│  今週の予定  │  │  予定入力    │
└──────────────┘  └──────────────┘
```

### 📍 状態遷移

**重要**: 締切機能は廃止されました。いつでも入力・修正が可能です。

```
集計中（入力期間）
  ↓ 日曜9:00
確定（表示期間）
```

各週は2つの状態のみ：
- **集計中**: 予定入力タブで表示、いつでも編集可能
- **確定**: 今週の予定タブに移動、ダッシュボードで閲覧可能（編集も可能）

## アーキテクチャ

### システム構成図

```
┌─────────────────────────────────────────────────────────┐
│                    LINE Platform                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────────────┐      │
│  │ Messaging│  │  Webhook │  │   LIFF App       │      │
│  │   API    │  │          │  │ (静的Webページ)   │      │
│  └─────┬────┘  └────┬─────┘  └────────┬─────────┘      │
└────────┼────────────┼─────────────────┼─────────────────┘
         │            │                 │
         │            │                 │
    ┌────▼────────────▼─────────────────▼─────┐
    │         API Gateway (REST API)           │
    └────┬─────────────────────────────────┬───┘
         │                                 │
         │                                 │
    ┌────▼─────────────────┐    ┌─────────▼──────┐
    │  Lambda Functions    │    │   S3 Bucket    │
    │  ┌────────────────┐  │    │  ┌──────────┐  │
    │  │ webhook        │  │    │  │dashboard │  │
    │  │ schedule-get   │  │    │  │  .html   │  │
    │  │ schedule-submit│  │    │  └──────────┘  │
    │  │ history-get    │  │    │  ┌──────────┐  │
    │  └────────────────┘  │    │  │  index   │  │
    └──────────┬───────────┘    │  │  .html   │  │
               │                │  └──────────┘  │
               │                └─────────────────┘
    ┌──────────▼───────────┐
    │  EventBridge         │
    │  Scheduler           │
    │  ┌────────────────┐  │
    │  │ 金 10:00       │  │
    │  │ weekly-reminder│  │ ← リマインド
    │  ├────────────────┤  │
    │  │ 日 9:00        │  │
    │  │ weekly-finalize│  │ ← 確定処理
    │  ├────────────────┤  │
    │  │ 月 7:00        │  │
    │  │ weekly-request │  │ ← PRIMARY入力依頼
    │  └────────────────┘  │
    └──────────┬───────────┘
               │
    ┌──────────▼───────────┐
    │  DynamoDB Tables     │
    │  ┌────────────────┐  │
    │  │ScheduleInputs  │  │ ← 週次入力データ
    │  ├────────────────┤  │
    │  │WeeklyFinalized │  │ ← 確定スケジュール
    │  ├────────────────┤  │
    │  │UserPoints      │  │ ← 累計ポイント
    │  ├────────────────┤  │
    │  │SystemConfig    │  │ ← システム設定
    │  └────────────────┘  │
    └──────────────────────┘
```

### AWS構成要素

| サービス | 用途 | 最適化 |
|---------|------|--------|
| **Lambda** | 各種ハンドラー実行 | メモリ256MB, パッケージ20MB |
| **API Gateway** | REST APIエンドポイント | - |
| **DynamoDB** | データ永続化 | TTL有効化（12週間） |
| **EventBridge Scheduler** | 定期実行 | 週4回のみ実行 |
| **S3** | 静的ファイル配信 | - |
| **Secrets Manager** | LINE認証情報管理 | - |
| **SQS** | Dead Letter Queue | エラー時のみ使用 |

## 主な機能

### 1. 週次スケジュール入力

**LIFF画面で簡単入力**:
- 1日5枠（終日、9時、17時、21時、24時）× 7日 = 35枠
- チェックボックスで簡単選択
- 日付ごとに備考を追加可能
- **いつでも上書き可能**（締切機能廃止）

### 2. 自動確定処理（日曜9:00）

**確定処理の流れ**:
```
1. 前週データを取得
   ↓
2. ポイントを自動計算
   ├─ 平日ポイント
   ├─ 土日加算ポイント
   └─ 合計ポイント
   ↓
3. 確定表テキストを生成
   ├─ 各日付の時間枠と参加者
   ├─ ⚠️ 担当者不在の日を検出・警告
   └─ 週次ポイント内訳
   ↓
4. データベースに保存
   ↓
5. LINEグループに投稿
   ├─ 確定スケジュール
   ├─ 担当者不在の日の警告
   ├─ 週次ポイント
   └─ ダッシュボードリンク
   ↓
6. 累計ポイントを更新
```

### 3. ダッシュボード（4タブ構成）

#### 📅 今週の予定
- 確定済みスケジュールを週別に表示
- ⚠️ 担当者不在の日をページヘッダーで警告表示
- 日付ごとの時間枠と参加者を確認
- 備考も表示
- 編集ボタンで確定後も修正可能

#### 📊 集計表示
- 週別の詳細集計表
- 日付×時間枠のマトリックス表示
- 各メンバーの予定を一覧表示

#### ✏️ 予定入力
- 各メンバーの入力状況を確認
- LIFFリンクで簡単入力

#### 🏆 累計
- メンバー別の累計ポイント表示
- 平日・土日加算の内訳を円グラフで可視化

### 4. 担当者不在日の警告機能

**自動検出と警告**:
- 全時間枠（終日、9時、17時、21時、24時）で誰も担当していない日を検出
- 確定処理時にLINEメッセージで警告
- ダッシュボードの「今週の予定」タブでも黄色い警告ボックスで表示
- 形式: `⚠️ 担当者不在の日: 12/29(月), 1/2(金)`

## セットアップ手順

### 前提条件

- AWS CLI インストール済み
- Node.js 20.x以上
- LINE公式アカウント（Messaging API有効化済み）

### 1. LINE設定

LINE Developers Consoleで以下を取得：
- CHANNEL_ID
- CHANNEL_SECRET
- CHANNEL_ACCESS_TOKEN_LONG（長期トークン）
- LIFF ID

### 2. Secrets Manager設定

```bash
aws secretsmanager create-secret \
  --name line/credentials-kame \
  --secret-string '{
    "CHANNEL_ID": "YOUR_CHANNEL_ID",
    "CHANNEL_SECRET": "YOUR_CHANNEL_SECRET",
    "CHANNEL_ACCESS_TOKEN_LONG": "YOUR_ACCESS_TOKEN",
    "LIFF_URL": "https://your-s3-bucket.s3.amazonaws.com",
    "ADMIN_USER_ID": "YOUR_ADMIN_LINE_USER_ID"
  }'
```

### 3. ビルド＆デプロイ

```bash
# 依存関係インストール
npm install

# TypeScriptビルド
npm run build

# Lambda関数デプロイ（個別）
# スクリプトを実行してパッケージ作成後、AWS CLIでアップロード
```

### 4. EventBridge Scheduler設定

| Schedule | Cron式 | 実行時刻 (JST) | Lambda関数 | 用途 |
|---------|--------|--------------|-----------|------|
| **weekly-reminder** | **`cron(0 1 ? * FRI *)`** | **金曜 10:00** | **weekly-reminder** | **リマインド** |
| **weekly-finalize** | **`cron(0 0 ? * SUN *)`** | **日曜 9:00** | **weekly-finalize** | **確定処理** |
| **weekly-request** | **`cron(0 22 ? * SUN *)`** | **月曜 7:00** | **weekly-request** | **PRIMARY入力依頼** |

## コスト最適化

### 実施済みの最適化

#### 1. Lambda関数の最適化

| 項目 | 最適化前 | 最適化後 | 削減率 |
|-----|---------|---------|--------|
| パッケージサイズ | 38MB | 20MB | **47%削減** |
| メモリサイズ | 512MB | 256MB | **50%削減** |

**最適化内容**:
- ソースマップ (.js.map) を除外
- TypeScript型定義 (.d.ts) を除外
- 不要な開発用依存関係を除外
- API関数のメモリを256MBに削減

#### 2. DynamoDB最適化

- **TTL有効化**: 12週間後に自動削除
- **PAY_PER_REQUEST**: 使用量に応じた課金

#### 3. 実行頻度の最適化

- **EventBridge**: 週3回のみ実行（金曜・日曜・月曜）
- **Lambda**: イベント駆動型で必要時のみ実行

### 月間コスト見積もり（概算）

- **Lambda**: 週3回 × 4週 = 月12回実行 → **無料枠内**
- **DynamoDB**: データ量少量 → **$1以下**
- **API Gateway**: 月間リクエスト少量 → **$1以下**
- **S3**: 静的ファイル配信 → **$0.5以下**
- **EventBridge**: 月12イベント → **無料枠内**

**合計**: 月額 **$3以下**

## データベース設計

### ScheduleInputs (週次入力)

```
PK: weekId (例: "2025-12-29")  # 月曜日の日付
SK: userId
displayName: LINEプロフィール名
slots: { "2025-12-29:allday": true, "2025-12-29:09": false, ... }
notes: { "2025-12-29": "備考テキスト", ... }
submittedAt: ISO8601
isLocked: false (常にfalse、締切機能廃止)
ttl: 12週間後のUNIXタイムスタンプ
```

### WeeklyFinalized (週次確定表)

```
PK: weekId
SK: "FINALIZED"
finalizedAt: ISO8601
scheduleText: 確定表テキスト
pointsBreakdown: {
  userId: {
    displayName: "名前",
    weekdayPoints: 5,
    weekendBonusPoints: 4,
    totalPoints: 9
  },
  ...
}
version: 修正回数
ttl: 12週間後のUNIXタイムスタンプ
```

### UserPoints (累計ポイント)

```
PK: userId
SK: "TOTAL"
displayName: 最新名前
totalPoints: 累計合計
weekdayPoints: 累計平日P
weekendBonusPoints: 累計土日加算P
lastUpdatedWeek: 最終更新weekId
updatedAt: ISO8601
```

### SystemConfig (システム設定)

```
PK: "CONFIG"
SK: "MAIN"
groupId: LINEグループID
timezone: "Asia/Tokyo"
```

## API仕様

### POST /webhook
LINE Webhook受信エンドポイント
- groupId自動保存（初回のみ）
- X-Line-Signature検証

### POST /schedule/submit
LIFF入力保存API
- データ保存（締切チェック廃止）
- LINEグループに結果投稿
- 修正用URLを常に表示

### GET /schedule/{weekId}
LIFF取得API
- 週情報取得
- 自分の入力データ取得

### GET /history
履歴取得API
- 確定済み週別データ取得（集計中の週は除外）
- 累計ポイント取得
- 担当者不在の日の情報も含む

## トラブルシューティング

### Q: グループにメッセージが届かない
A: SystemConfigテーブルにgroupIdが保存されているか確認。グループで何かメッセージを送信してgroupId自動保存を実行。

### Q: ダッシュボードが表示されない
A: S3バケットポリシーで公開設定されているか確認。dashboard.htmlのAPI_BASE_URLが正しいか確認。

### Q: ポイント計算が合わない
A: src/utils/points.tsのcalculatePoints関数を確認。土日判定（isWeekend）が正しく動作しているか確認。

### Q: 担当者不在の警告が表示されない
A: weekly-finalize.tsのbuildFinalizedSchedule関数が正しくデプロイされているか確認。dashboard.htmlも最新版がS3にアップロードされているか確認。

### Q: 曜日表示がずれている
A: JST timezone (`T00:00:00+09:00`) が正しく使用されているか確認。new Date(dateStr)ではなくnew Date(dateStr + 'T00:00:00+09:00')を使用。

## ライセンス

MIT

---

**開発日**: 2025年12月
**最終更新**: 2026年1月5日

## プロジェクト構造

```
schedule.app-1/
├── src/
│   ├── handlers/          # Lambda関数ハンドラー
│   │   ├── webhook.ts
│   │   ├── schedule-submit.ts
│   │   ├── schedule-get.ts
│   │   ├── schedule-week-get.ts
│   │   ├── history-get.ts
│   │   ├── weekly-reminder.ts      # 金曜10:00リマインド
│   │   ├── weekly-request.ts       # 月曜7:00入力依頼（PRIMARY）
│   │   └── weekly-finalize.ts      # 日曜9:00確定処理
│   ├── utils/             # 共通ユーティリティ
│   │   ├── constants.ts   # 定数・URL生成
│   │   ├── dynamodb.ts    # DynamoDB操作
│   │   ├── line.ts        # LINE API共通処理
│   │   ├── points.ts      # ポイント計算
│   │   ├── secrets.ts     # Secrets Manager
│   │   ├── signature.ts   # LINE署名検証
│   │   └── weekId.ts      # 週ID計算
│   └── types/
│       └── index.ts       # 型定義
├── web/
│   ├── dashboard.html     # 管理ダッシュボード
│   └── index.html         # 予定入力ページ
├── template.yaml          # SAM設定（参考用）
├── tsconfig.json
└── package.json
```

## 変更履歴

### 2026年1月5日 - コードリファクタリング & AWS最適化
- ✅ **冗長性の削除**: 重複ディレクトリ・ファイルを削減（約650MB削減）
  - deploy/, lambda-deploy/, lambda-test/ ディレクトリを削除
  - 重複zipファイル（122MB）を削除
  - 一時テストファイルを削除
- ✅ **コードの統合**: 共通処理をユーティリティ化
  - `pushMessage`関数を `utils/line.ts` に統合
  - S3 URL生成を `utils/constants.ts` に統合
  - 3つのLambda関数で重複していたコードを削減
- ✅ **.gitignoreの改善**: 不要ファイルの除外設定を強化
- ✅ **AWS側の最適化**:
  - EventBridge Schedulerの時刻設定を修正（正確なJST時刻に）
  - weekly-input-reminder Lambda関数を削除（weekly-requestに統合）
  - 全Lambda関数のメモリサイズを256MBに最適化（コスト削減50%）

### 2025年12月31日 - メジャーアップデート
- ✅ **締切機能の廃止**: いつでも入力・修正が可能に
- ✅ **タイミングシステムの再設計**:
  - 金曜10:00: リマインド送信（旧：入力依頼）
  - 日曜9:00: 確定処理（変更なし）
  - 月曜7:00: PRIMARY入力依頼送信（旧：リマインド）
- ✅ **担当者不在日の警告機能追加**:
  - 確定処理時に自動検出
  - LINEメッセージで警告
  - ダッシュボードにも警告表示
- ✅ **曜日表示の修正**: JST timezone統一で正確な曜日表示
- ✅ **集計中週の分離**: 今週の予定タブから集計中週を除外
- ✅ **コード最適化**: Lambda関数の軽量化とコスト削減
